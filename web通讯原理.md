# Internet 数据传输实现解析

## 前言：

最近有幸跟着大佬参与一个项目，主要实现 在线聊天、分享的功能，很明显需要了解互联网输出传输模式，在此根据 《Netty 核心原理余 RPC 框架原理》 一书进行学习，并探讨、实践出一个最佳的 在线聊天实现方式

## 网络传输的现实意义：

### 广泛的场景： C/S 架构

软件产品一般分为：客户端 client、服务端 Server 两部分，使用Socket 进行服务端与客户端之间的通信

### 简单的实现流程：五步骤

- 客户端产生数据，存放于客户端内存中，调用接口将内存中的数据发送/拷贝给操作系统内存
- 操作系统接受数据后，按照指定地规则即<font color=red>协议</font> ，通过网卡发送数据
- 网络传输数据
- 服务端应用调用系统接口，要求将数据从操作系统内存拷贝到自己内存
- 服务端操作系统接受指令后，与客户端使用相同的规则，从网卡读取数据，并拷备给服务端应用

### 自然引出 网络层级划分：

计算机之间需要统一的标准才能相互通信，该标准被称为互联网协议，网络就是：物理链接介质+互联网协议

按照功能不同，约定将互联网协议分为：OSI 七层、TCP/IP 五层 或 四层：

![](https://gitee.com/gaoxiang15125/pictureBed/raw/master/img/传输协议五层模型七层模型.png)



![](https://gitee.com/gaoxiang15125/pictureBed/raw/master/img/各层模型对应的物理实现.png)

#### 五层模型每层的含义:

**注意事项**：

无论什么样的请求方式，最终都是要经由数据链路层 包装为 帧 进行传输的

- 物理层：基于电器特性发送高低电平，其实就是传输 0 1 信号

- 数据链路层：将电平信号 0 1 进行分组，赋予其具体的含义。即：定义电平信号分组方式

  - 以太网协议：
    -  数据链路层使用以太网协议进行数据传输
    - 基于 MAC 地址的广播方式实现数据传输
    - 只能在局域网内广播
    - 早期各公司有自己的分组方式，后来形成统一的标准，即：以太网协议 Ethernet
  - Ethernet 以太网协议：以太网协议 标准的实现（也不该存在第二种了）
    - 帧：由一组电平信号构成一个数据包，即帧，每帧由 Head Data 构成
      - Head: 固定18字节，发送者/源地址 6 字节；接收者/目标地址6字节；数据类型 6 字节
      - Data：最短46字节，最长1500字节；数据包的具体内容格式为：Head 长度+Data长度= 最短 64 字节，最长 1518 字节（超过最大限制就分片发送）
    - MAC 地址：网卡出厂时创建的唯一 MAC 地址，一个长度为 48位 的二进制数，一般使用 12 位十六进制数表示（前6位为厂商编号，后6位为流水线号） <font color=red>可以理解为物理机的唯一地址</font>
    - Broadcast 广播
      - 同一个以太网下 通过广播的方式进行数据传输
      - 两台主机通过 ARP 协议获取双方的MAC地址，通过广播通知以太网下所有主机，解析目标地址为本机地址则视为收到了消息
      - <font color=red>很明显存在严重的效率问题，数量上去后总线压力非常大

- 网络层：网络是由一个个局域网组成的，同一个局域网是一个广播域，跨广播域的数据传输需要经过路由转发 —— 需要设计一个模型，可以区分计算机是否在同一个广播域，并可以通过该方法找到目标计算机的地址；<font color=red>这就是 网络层 </font>

- 网络层：引入一套新的地址来区分不同的广播域/子网，即：网络地址

  - 规定网络地址的协议为 IP（Internet Protocol）IP地址
    - 由32位二进制数表示，通常写为 四段十进制数 常见不多说了
    - 有两部分组成：网络部分(标识子网) 主机部分（识别主机）
    - 子网掩码，标识那部分为子网，哪部分为主机部分
  - IP 数据包
    - 直接作为 以太网数据包 Data 部分即可
    - Head: 20~60 字节； Data: 最长为 65515 字节
    - 长度超过单个以太网数据包长度，则进行多次分割操作，作为几个以太网数据包进行发送
    
  - ARP （Address Resolution Protocol 地址解析协议）
  - 实现从 IP 地址 到 MAC 地址协议的映射，并通过广播的方式发送数据包
    - 可以理解为 找不到就通过 255 的广播地址进行广播，并发送 自身 IP MAC 的映射关系，目标地址单播返回，并通知自己的 IP 与 MAC 地址，之后就可以带上 mac 地址愉快的发送了

- 传输层：我们可以在计算机之间进行数据传输了，但是实际上也只是到了 内核/操作系统的层面，如何确定交给哪个应用程序处理呢？这就涉及到了端口 Port

  - 端口： 应用程序与网卡的关联的编号；
  - **传输层：用来建立端口到端口的通信机制**
  - TCP（Transmission Control Protocol）： 可靠传输协议
    - 一条消息结构： 以太网头部|IP头部|TCP头部|数据
    - 理论无长度限制，但实际不超过 IP 数据包长度
  - UDP （User Datagram Protocol 用户数据报协议） 不可靠的传输协议
    - 报头 8 字节，不超过单个 IP 数据包长度
    - 以太网头部|IP头部|UDP头部|数据
  - TCP 详解
    - TCP 报文结构 因为不是特别重要，简单有个印象即可
    - TCP 建立链接、数据传输、断开连接 流程图

- 应用层：规定 应用程序的数据格式

  - DNS 协议 Domain Name System 域名系统
    - DNS是英文Domain Name System（域名系统）的缩写，用来把便于人们使用的机器名字转换为IP地址。现在顶级域 TLD（Totel Lead Domination）分为三大类：国家顶级域名nTLD、通用顶级域名gTLD和基础结构域名。域名服务器分为四种类型：根域名服务器、顶级域名服务器、本地域名服务器和权限域名服务器。DNS使用TCP和UDP端口53。当前，对于每一级域名长度的限制是63个字符，域名总长度则不能超过253个字符。
  - HTTP 协议（HyperText Transfer Protocol 超文本传输协议）
    - 面向事务的应用层协议， 使用面向链接的 TCP 作为运输层协议，保证数据的可靠传输
  - FTP 协议（File Transfer Protocol 文件传输协议）
  - SMTP 协议
  - POP3 协议
  - Telnet 协议

- 获取主机四要素（IP地址 子网掩码 网关IP地址 DNSIP地址）

- 一种 静态获取 ，另一种为 DHCP 协议获取

- 一个网页访问，服务器做了什么事？

  ```
  第一步，本机设置以下信息。
  
  第二步，打开浏览器，想要访问咕泡官网，在地址栏中输入网址
  www.xxx.com。
  
  第三步，通过访问DNS域名系统服务器（基于UDP）获得IP地址。
  
  第四步，向目标机器发起HTTP请求，获得如下格式的数据内容。
  我们假定这个部分的长度为4960字节，它会被嵌在TCP数据包中。
  
  第五步，TCP。TCP数据包需要设置端口，接收方（咕泡官网）的
  HTTP端口默认是80，发送方（本机）的端口是一个随机生成的1024～
  65535之间的整数，假定为51775。TCP数据包的头部长度为20字节，加
  上嵌入HTTP的数据包，总长度变为4980字节。
  
  第六步，IP。TCP数据包再嵌入IP数据包。IP数据包需要设置双方
  的IP地址，这是已知的。IP数据包的头部长度为20字节，加上嵌入的
  TCP数据包，总长度变为5000字节。
  
  第七步，以太网协议。IP数据包嵌入以太网数据包。以太网数据包
  需要设置双方的MAC地址，发送方为本机的网卡MAC地址，接收方为网关
  192.168.1.1的MAC地址（通过ARP得到）。以太网数据包的数据部分最
  大长度为1500字节，而现在的IP数据包长度为5000字节。因此，IP数据包必须分割成四个包。因为每个包都有自己的IP头部（20字节），所以
  四个包的长度分别为1500字节、1500字节、1500字节、560字节。
  
  第八步，服务器响应。经过多个网关的转发，目标服务器收到了这四个以太网数据包。
  ```

#### Socket 网络之魂：

为了可以在网络中唯一标识出一个用户进程而引入的概念

- 使用 IP 地址+协议+端口号 唯一标识网络中的一个进程 （多个进程可以共享端口嘛？？）客户端目标可以多个，但是服务器只能一个
- Socket 是 应用层与传输层 之间的一个抽象层，把 TCP/IP 层复杂的操作抽象为几个简单的接口供应用层调用，以实现进程在网络中的通信
- 



  

  

  

